<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>3D Vehicle MVP (three.js)</title>
  <style> html,body{height:100%;margin:0} canvas{display:block} #hud { position:absolute; left:10px; top:10px; color:#fff; font-family:monospace; background:rgba(0,0,0,0.4); padding:8px; border-radius:6px; }</style>
</head>
<body>
<div id="hud">Status: Ready</div>
<script type="module">
import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.156.0/build/three.module.js';
import { OrbitControls } from 'https://cdn.jsdelivr.net/npm/three@0.156.0/examples/jsm/controls/OrbitControls.js';
import { GLTFLoader } from 'https://cdn.jsdelivr.net/npm/three@0.156.0/examples/jsm/loaders/GLTFLoader.js';

const scene = new THREE.Scene();
scene.background = new THREE.Color(0x20232a);

const camera = new THREE.PerspectiveCamera(50, innerWidth / innerHeight, 0.1, 1000);
camera.position.set(0, 4, 8);

const renderer = new THREE.WebGLRenderer({ antialias: true });
renderer.setSize(innerWidth, innerHeight);
document.body.appendChild(renderer.domElement);

window.addEventListener('resize', ()=> {
  camera.aspect = innerWidth/innerHeight; camera.updateProjectionMatrix();
  renderer.setSize(innerWidth, innerHeight);
});

const controls = new OrbitControls(camera, renderer.domElement);
controls.target.set(0,1,0);
controls.update();

// Lights
const hemi = new THREE.HemisphereLight(0xffffff, 0x444444, 1.0);
hemi.position.set(0, 50, 0); scene.add(hemi);
const dir = new THREE.DirectionalLight(0xffffff, 0.8);
dir.position.set(-5,10,5); scene.add(dir);

// Ground plane
const ground = new THREE.Mesh(new THREE.PlaneGeometry(200,200), new THREE.MeshStandardMaterial({ color: 0x333333 }));
ground.rotation.x = -Math.PI/2; scene.add(ground);

// Load vehicle model (glTF). Put vehicle.gltf or vehicle.glb in same folder.
let vehicle;
const loader = new GLTFLoader();
loader.load('vehicle.gltf', (gltf) => {
  vehicle = gltf.scene;
  // scale/center as needed
  vehicle.scale.set(1,1,1);
  vehicle.position.set(0,0,0);
  scene.add(vehicle);
  document.getElementById('hud').innerText = 'Status: Vehicle loaded';
}, (xhr)=> {
  // progress
  // console.log( (xhr.loaded / xhr.total * 100) + '% loaded' );
}, (err)=> {
  console.error(err); document.getElementById('hud').innerText = 'Status: Failed to load model';
});

// Simple animation params (telemetry-driven)
let targetPose = { x:0, y:0, z:0, yaw:0 }; // meters & radians

function animate() {
  requestAnimationFrame(animate);
  // smooth move vehicle toward targetPose
  if (vehicle) {
    vehicle.position.x += (targetPose.x - vehicle.position.x) * 0.1;
    vehicle.position.z += (targetPose.z - vehicle.position.z) * 0.1;
    const currentYaw = vehicle.rotation.y;
    const yawDiff = targetPose.yaw - currentYaw;
    vehicle.rotation.y += yawDiff * 0.1;
  }
  renderer.render(scene, camera);
}
animate();

// Example: simulate telemetry updates every 2s (replace with WebSocket)
setInterval(() => {
  // Generate a small random move
  const nx = (Math.random()-0.5)*8;
  const nz = (Math.random()-0.5)*8;
  const nyaw = Math.random()*Math.PI*2;
  targetPose = { x:nx, y:0, z:nz, yaw:nyaw };
  document.getElementById('hud').innerText = `Status: Telemetry update: x=${nx.toFixed(2)} z=${nz.toFixed(2)} yaw=${(nyaw).toFixed(2)}`;
}, 2000);

// Optional: WebSocket example (uncomment and adapt URL)
/*
const ws = new WebSocket('ws://localhost:8765');
ws.onopen = ()=>{ console.log('ws open'); };
ws.onmessage = (ev) => {
  // expect JSON: {x:..., z:..., yaw:...}
  try {
    const d = JSON.parse(ev.data);
    targetPose.x = d.x; targetPose.z = d.z; targetPose.yaw = d.yaw;
    document.getElementById('hud').innerText = `Status: ws recv x=${d.x} z=${d.z}`;
  } catch(e){ console.warn(e); }
};
*/
</script>
</body>
</html>
